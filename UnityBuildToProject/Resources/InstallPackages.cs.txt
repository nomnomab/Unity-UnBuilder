using System;
using System.IO;
using System.Linq;
using System.Collections.Generic;
using UnityEditor;
using UnityEditor.PackageManager.Requests;
using UnityEditor.PackageManager;
using UnityEngine;

namespace Nomnom {
    public static class InstallPackages {
        // this gets filled via the tool
        private static int _toAddCount = #_PACKAGE_INSTALL_COUNT;
        private static Stack<string> _toAdd = new Stack<string>(new string[] {
#_PACKAGES_TO_INSTALL_
        });
        
        private static int _toRemoveCount = #_PACKAGE_REMOVE_COUNT;
        private static Stack<string> _toRemove = new Stack<string>(new string[] {
#_PACKAGES_TO_REMOVE_
        });
        
        static AddRequest    AddRequest;
        static RemoveRequest RemoveRequest;
        
        static void UpdateSettings() {
            var playerSettings = Resources.FindObjectsOfTypeAll<PlayerSettings>().First();
            var playerSettingsObject = new SerializedObject(playerSettings);
            playerSettingsObject.Update();
            
            if (_toAdd.Any(x => x.StartsWith("com.unity.inputsystem"))) {
                Debug.Log("Has new input system");
                
                var buildTargetGroup = EditorUserBuildSettings.selectedBuildTargetGroup;
                var scriptingDefines = PlayerSettings.GetScriptingDefineSymbolsForGroup(buildTargetGroup);
                if (!scriptingDefines.Contains("NEW_INPUT_SYSTEM_ENABLED")) {
                    scriptingDefines.Replace(";NEW_INPUT_SYSTEM_ENABLED", "");
                    if (true) {
                        scriptingDefines += ";NEW_INPUT_SYSTEM_ENABLED";
                    }
                    
                    Debug.Log(scriptingDefines);
                    PlayerSettings.SetScriptingDefineSymbolsForGroup(buildTargetGroup, scriptingDefines);
                    AssetDatabase.SaveAssets();
                    AssetDatabase.Refresh();
                }
            }
        }
        
        public static void OnLoad() {
            UpdateSettings();
            
            Debug.Log(_toAddCount + " packages to install!");
            while (_toAdd.Count > 0) {
                var name = _toAdd.Pop();
                
                Debug.Log("Installing package: " + name);
                AddRequest = Client.Add(name);
                
                while (!AddRequest.IsCompleted) { }
                
                Debug.Log("Status: " + AddRequest.Status);
                
                if (AddRequest.Status == StatusCode.Success) {
                    // installed package
                } else if (AddRequest.Status >= StatusCode.Failure) {
                    Debug.LogWarning(AddRequest.Error.message);
                }
                
                AddRequest = null;
            }
            
            Debug.Log(_toRemoveCount + " packages to remove!");
            while (_toRemove.Count > 0) {
                var name = _toRemove.Pop();
                
                Debug.Log("Removing package: " + name);
                RemoveRequest = Client.Remove(name);
                
                while (!RemoveRequest.IsCompleted) { }
                
                Debug.Log("Status: " + RemoveRequest.Status);
                
                if (RemoveRequest.Status == StatusCode.Success) {
                    // removed package
                } else if (RemoveRequest.Status >= StatusCode.Failure) {
                    Debug.LogWarning(RemoveRequest.Error.message);
                }
                
                RemoveRequest = null;
            }
            
            Debug.Log($"Done installing packages!");
            EditorUtility.ClearProgressBar();
            EditorApplication.Exit(0);
        }
        
        /*[InitializeOnLoadMethod]
        public static void RunOnLoad() {
            return;
            UpdateSettings();
            
            var name = _toAdd.Pop();
            var t = (_toAddCount - _toAdd.Count) / (float)_toAddCount;
            EditorUtility.DisplayProgressBar("Installing packages", "Installing " + name, t);
            
            AddRequest  = Client.Add(name);
            Debug.Log("Installing package: " + name);
            
            EditorApplication.update += Progress;
        }
        
        static void Progress() {
            if (AddRequest == null) {
                if (_toAdd.Count == 0) {
                    Debug.Log($"Done installing packages!");
                    EditorUtility.ClearProgressBar();
                    
                    EditorApplication.update -= Progress;
                    EditorApplication.Exit(0);
                    
                    return;
                }
                
                var name = _toAdd.Pop();
                
                var t = (_toAddCount - _toAdd.Count) / (float)_toAddCount;
                EditorUtility.DisplayProgressBar("Installing packages", "Installing " + name, t);
                
                AddRequest  = Client.Add(name);
                Debug.Log("Installing package: " + name);
                
                return;
            }
            
            if (AddRequest.IsCompleted) {
                if (AddRequest.Status == StatusCode.Success) {
                    // installed package
                } else if (AddRequest.Status >= StatusCode.Failure) {
                    Debug.LogWarning(AddRequest.Error.message);
                }
                
                AddRequest = null;
            }
        }*/
    }
}
